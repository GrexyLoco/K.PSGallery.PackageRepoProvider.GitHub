name: Publish GitHub Provider to GitHub Packages

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.1.0). Leave empty to use Smartagr for automatic versioning.'
        required: false
        type: string

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout GitHub Provider
        uses: actions/checkout@v4
        with:
          path: K.PSGallery.PackageRepoProvider.GitHub
      
      - name: Checkout PackageRepoProvider (Bootstrap)
        uses: actions/checkout@v4
        with:
          repository: GrexyLoco/K.PSGallery.PackageRepoProvider
          path: K.PSGallery.PackageRepoProvider
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Checkout Smartagr (Release Automation)
        uses: actions/checkout@v4
        with:
          repository: GrexyLoco/K.PSGallery.Smartagr
          path: K.PSGallery.Smartagr
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Initialize Environment
        shell: pwsh
        run: |
          cd K.PSGallery.PackageRepoProvider.GitHub
          ./.github/scripts/Initialize-Environment.ps1
      
      - name: Run Pester Tests
        shell: pwsh
        run: |
          cd K.PSGallery.PackageRepoProvider.GitHub
          ./.github/scripts/Test-PesterTests.ps1
      
      - name: Run Code Quality Analysis
        shell: pwsh
        run: |
          cd K.PSGallery.PackageRepoProvider.GitHub
          ./.github/scripts/Test-CodeQuality.ps1
      
      - name: Bootstrap LOCAL Modules
        shell: pwsh
        run: |
          cd K.PSGallery.PackageRepoProvider.GitHub
          ./.github/scripts/Install-FromLocal.ps1
      
      - name: Publish to GitHub Packages
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Determine version (optional - Smartagr will determine if not provided)
          $version = "${{ github.event.inputs.version }}"
          if ([string]::IsNullOrEmpty($version)) {
            $version = "${{ github.event.release.tag_name }}".TrimStart('v')
          }
          
          cd K.PSGallery.PackageRepoProvider.GitHub
          
          try {
            $secureToken = ConvertTo-SecureString -String $env:GITHUB_TOKEN -AsPlainText -Force
            
            # Pass version only if it's not empty, otherwise let Smartagr determine it
            if (-not [string]::IsNullOrEmpty($version)) {
              ./.github/scripts/Publish-ToGitHubPackages.ps1 -SecureToken $secureToken -Version $version
            } else {
              ./.github/scripts/Publish-ToGitHubPackages.ps1 -SecureToken $secureToken
            }
          } catch {
            $registryUri = 'https://nuget.pkg.github.com/GrexyLoco/index.json'
            ./.github/scripts/Write-ErrorSummary.ps1 -ErrorMessage $_.Exception.Message -Version $version -RegistryUri $registryUri
            throw
          }
