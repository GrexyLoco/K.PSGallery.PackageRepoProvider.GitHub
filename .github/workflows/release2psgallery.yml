name: Publish GitHub Provider to GitHub Packages

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.1.0). Leave empty to auto-determine from K.Action.NextVersion.'
        required: false
        type: string

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout GitHub Provider
        uses: actions/checkout@v4
        with:
          path: K.PSGallery.PackageRepoProvider.GitHub
      
      - name: Checkout PackageRepoProvider (Bootstrap)
        uses: actions/checkout@v4
        with:
          repository: GrexyLoco/K.PSGallery.PackageRepoProvider
          path: K.PSGallery.PackageRepoProvider
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Initialize Environment
        shell: pwsh
        run: |
          cd K.PSGallery.PackageRepoProvider.GitHub
          ./.github/scripts/Initialize-Environment.ps1
      
      - name: Run Pester Tests
        shell: pwsh
        run: |
          cd K.PSGallery.PackageRepoProvider.GitHub
          ./.github/scripts/Test-PesterTests.ps1
      
      - name: Run Code Quality Analysis
        shell: pwsh
        run: |
          cd K.PSGallery.PackageRepoProvider.GitHub
          ./.github/scripts/Test-CodeQuality.ps1
      
      - name: Bootstrap LOCAL Modules
        shell: pwsh
        run: |
          cd K.PSGallery.PackageRepoProvider.GitHub
          ./.github/scripts/Install-FromLocal.ps1
      
      - name: Determine Next Version
        id: next-version
        uses: GrexyLoco/K.Action.NextVersion@v1
        if: github.event.inputs.version == ''
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Publish to GitHub Packages
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Determine version from input, release tag, or K.Action.NextVersion
          $version = "${{ github.event.inputs.version }}"
          if ([string]::IsNullOrEmpty($version)) {
            $version = "${{ github.event.release.tag_name }}".TrimStart('v')
          }
          if ([string]::IsNullOrEmpty($version)) {
            $version = "${{ steps.next-version.outputs.version }}"
          }
          
          if ([string]::IsNullOrEmpty($version)) {
            throw "Version could not be determined. Ensure either workflow_dispatch includes a version or release has a tag_name."
          }
          
          Write-Host "Publishing version: $version"
          
          cd K.PSGallery.PackageRepoProvider.GitHub
          
          try {
            $secureToken = ConvertTo-SecureString -String $env:GITHUB_TOKEN -AsPlainText -Force
            ./.github/scripts/Publish-ToGitHubPackages.ps1 -SecureToken $secureToken -Version $version
          } catch {
            $registryUri = 'https://nuget.pkg.github.com/GrexyLoco/index.json'
            ./.github/scripts/Write-ErrorSummary.ps1 -ErrorMessage $_.Exception.Message -Version $version -RegistryUri $registryUri
            throw
          }
      
      - name: Create Release with Smartagr
        uses: GrexyLoco/K.PSGallery.Smartagr@v1
        if: success()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          version: ${{ steps.next-version.outputs.version || github.event.inputs.version || github.event.release.tag_name }}
