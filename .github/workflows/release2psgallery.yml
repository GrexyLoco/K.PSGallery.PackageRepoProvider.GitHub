name: Publish GitHub Provider to GitHub Packages

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.1.0)'
        required: true
        type: string

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout GitHub Provider
        uses: actions/checkout@v4
        with:
          path: K.PSGallery.PackageRepoProvider.GitHub
      
      - name: Checkout PackageRepoProvider (Bootstrap)
        uses: actions/checkout@v4
        with:
          repository: GrexyLoco/K.PSGallery.PackageRepoProvider
          path: K.PSGallery.PackageRepoProvider
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Checkout PesterTestDiscovery (Bootstrap)
        uses: actions/checkout@v4
        with:
          repository: GrexyLoco/K.PSGallery.PesterTestDiscovery
          path: K.PSGallery.PesterTestDiscovery
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Initialize Environment
        shell: pwsh
        run: |
          cd K.PSGallery.PackageRepoProvider.GitHub
          ./.github/scripts/Initialize-Environment.ps1
      
      - name: Discover Pester Tests
        shell: pwsh
        run: |
          cd K.PSGallery.PackageRepoProvider.GitHub
          
          # Import PesterTestDiscovery module
          $discoveryPath = '../K.PSGallery.PesterTestDiscovery/K.PSGallery.PesterTestDiscovery.psd1'
          if (-not (Test-Path $discoveryPath)) {
            throw "K.PSGallery.PesterTestDiscovery not found at: $discoveryPath"
          }
          Import-Module $discoveryPath -Force
          
          # Run discovery with GitHubActions output format (sets environment variables)
          Invoke-TestDiscovery -TestPath 'Tests' -OutputFormat 'GitHubActions' -Detailed
      
      - name: Run Pester Tests
        shell: pwsh
        run: |
          cd K.PSGallery.PackageRepoProvider.GitHub
          
          # Check if tests were discovered
          if ($env:test-files-count -eq '0' -or [string]::IsNullOrEmpty($env:test-files-count)) {
            Write-Output "‚ö†Ô∏è  No test files discovered - skipping Pester tests"
            exit 0
          }
          
          if ([string]::IsNullOrEmpty($env:discovered-paths)) {
            Write-Output "‚ö†Ô∏è  No test paths discovered - skipping Pester tests"
            exit 0
          }
          
          Write-Output "‚úÖ Found $env:test-files-count test file(s)"
          Write-Output "üß™ Running Pester tests on discovered paths..."
          
          # Run Pester on discovered paths
          $config = New-PesterConfiguration
          $config.Run.Path = $env:discovered-paths -split ';'
          $config.Run.PassThru = $true
          $config.Output.Verbosity = 'Detailed'
          $config.CodeCoverage.Enabled = $false
          
          $result = Invoke-Pester -Configuration $config
          
          if ($result.FailedCount -gt 0) {
            throw "Pester tests failed: $($result.FailedCount) failed out of $($result.TotalCount)"
          }
          
          Write-Output "‚úÖ All Pester tests passed ($($result.PassedCount)/$($result.TotalCount))"
      
      - name: Run Code Quality Analysis
        shell: pwsh
        run: |
          cd K.PSGallery.PackageRepoProvider.GitHub
          ./.github/scripts/Test-CodeQuality.ps1
      
      - name: Bootstrap LOCAL Modules
        shell: pwsh
        run: |
          cd K.PSGallery.PackageRepoProvider.GitHub
          ./.github/scripts/Install-FromLocal.ps1
      
      - name: Publish to GitHub Packages
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Determine version
          $version = "${{ github.event.inputs.version }}"
          if ([string]::IsNullOrEmpty($version)) {
            $version = "${{ github.event.release.tag_name }}".TrimStart('v')
          }
          
          cd K.PSGallery.PackageRepoProvider.GitHub
          
          try {
            $secureToken = ConvertTo-SecureString -String $env:GITHUB_TOKEN -AsPlainText -Force
            ./.github/scripts/Publish-ToGitHubPackages.ps1 -SecureToken $secureToken -Version $version
          } catch {
            $registryUri = 'https://nuget.pkg.github.com/GrexyLoco/index.json'
            ./.github/scripts/Write-ErrorSummary.ps1 -ErrorMessage $_.Exception.Message -Version $version -RegistryUri $registryUri
            throw
          }
