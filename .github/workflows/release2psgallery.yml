name: ðŸš€ Release GitHub Provider

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ðŸ“Œ Override version (e.g., 0.1.0, leave empty for auto-detection)'
        required: false
        type: string
        default: ''
      enable-psgallery-notification:
        description: 'ðŸ“£ Enable notification to K.PSGallery pipeline'
        required: false
        type: boolean
        default: false
  pull_request:
    types: [closed]
    branches: [master, main]

env:
  RELEASE_AUTHOR: "github-actions[bot]"
  RELEASE_EMAIL: "github-actions[bot]@users.noreply.github.com"
  UBUNTU_VERSION: ${{ vars.UBUNTU_VERSION || 'ubuntu-24.04' }}
  ENABLE_PSGALLERY_NOTIFICATION: 'false'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ”§ BOOTSTRAP - Dependencies die noch nicht als Actions/Packages verfÃ¼gbar
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  bootstrap:
    name: ðŸ”§ Bootstrap Dependencies
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ${{ vars.UBUNTU_VERSION || 'ubuntu-24.04' }}
    steps:
      - name: ðŸ“¥ Checkout GitHub Provider
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Bootstrap PackageRepoProvider
        uses: actions/checkout@v4
        with:
          repository: GrexyLoco/K.PSGallery.PackageRepoProvider
          path: .bootstrap/K.PSGallery.PackageRepoProvider
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”§ Initialize Environment
        shell: pwsh
        run: ./.github/scripts/Initialize-Environment.ps1

      - name: ðŸ”§ Install Bootstrap Modules
        shell: pwsh
        run: ./.github/scripts/Install-FromLocal.ps1

      - name: âœ… Bootstrap Complete
        run: |
          echo "## âœ… Bootstrap Complete" >> $GITHUB_STEP_SUMMARY
          echo "Dependencies ready for Quality Gate" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ” QUALITY GATE - Security & Tests
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  quality-gate:
    name: ðŸ” Security & ðŸ§ª Tests
    needs: bootstrap
    runs-on: ${{ vars.UBUNTU_VERSION || 'ubuntu-24.04' }}
    outputs:
      test-success: ${{ steps.validation.outputs.test-success }}
      module-name: ${{ steps.discover-module.outputs.module-name }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Re-Bootstrap Dependencies
        uses: actions/checkout@v4
        with:
          repository: GrexyLoco/K.PSGallery.PackageRepoProvider
          path: .bootstrap/K.PSGallery.PackageRepoProvider
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”§ Re-Initialize Environment
        shell: pwsh
        run: |
          ./.github/scripts/Initialize-Environment.ps1
          ./.github/scripts/Install-FromLocal.ps1

      - name: ðŸ” Auto-discover module name
        id: discover-module
        shell: pwsh
        run: |
          $moduleName = "K.PSGallery.PackageRepoProvider.GitHub"
          "module-name=$moduleName" >> $env:GITHUB_OUTPUT
          "## ðŸ” Module Discovery" >> $env:GITHUB_STEP_SUMMARY
          "**Module:** ``$moduleName``" >> $env:GITHUB_STEP_SUMMARY

      - name: ðŸ§ª Validate PowerShell Module
        id: validation
        uses: GrexyLoco/K.Actions.PSModuleValidation@v1.4.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          module-name: ${{ steps.discover-module.outputs.module-name }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ“¦ PREPARE RELEASE - Version Management & PSD1 Update
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  prepare-release:
    name: ðŸ“¦ Prepare Release
    needs: [bootstrap, quality-gate]
    runs-on: ${{ vars.UBUNTU_VERSION || 'ubuntu-24.04' }}
    outputs:
      new-version: ${{ steps.determine-version.outputs.final-version }}
      bump-type: ${{ steps.next-version.outputs.bumpType }}
      should-release: ${{ steps.determine-version.outputs.should-release }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”§ Re-Bootstrap Dependencies
        uses: actions/checkout@v4
        with:
          repository: GrexyLoco/K.PSGallery.PackageRepoProvider
          path: .bootstrap/K.PSGallery.PackageRepoProvider
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”§ Re-Initialize Environment
        shell: pwsh
        run: |
          ./.github/scripts/Initialize-Environment.ps1
          ./.github/scripts/Install-FromLocal.ps1

      - name: â¬†ï¸ Analyze next version
        id: next-version
        if: github.event.inputs.version == ''
        uses: GrexyLoco/K.Actions.NextVersion@latest
        with:
          branchName: ${{ github.ref_name }}

      - name: ðŸ”¢ Determine final version
        id: determine-version
        shell: pwsh
        run: |
          ./.github/scripts/Get-NextVersion.ps1 `
            -ManualVersion '${{ github.event.inputs.version }}' `
            -AutoBumpType '${{ steps.next-version.outputs.bumpType }}' `
            -AutoNewVersion '${{ steps.next-version.outputs.newVersion }}'

      - name: ðŸ›‘ Skip if no changes
        if: steps.determine-version.outputs.should-release == 'false'
        run: |
          echo "## ðŸ” No Release Required" >> $GITHUB_STEP_SUMMARY
          echo "â„¹ï¸ No version changes - workflow exits gracefully" >> $GITHUB_STEP_SUMMARY
          exit 0

      - name: ðŸ“ Update PowerShell Module Version
        if: steps.determine-version.outputs.should-release == 'true'
        shell: pwsh
        run: |
          $newVersion = '${{ steps.determine-version.outputs.final-version }}'
          $psd1 = Get-ChildItem -Filter '*.psd1' -File | Select-Object -First 1
          
          if ($psd1) {
            Write-Output "ðŸ“ Updating $($psd1.Name) to version $newVersion"
            Update-ModuleManifest -Path $psd1.FullName -ModuleVersion $newVersion
            
            git config user.name "${{ env.RELEASE_AUTHOR }}"
            git config user.email "${{ env.RELEASE_EMAIL }}"
            git add $psd1.Name
            git commit -m "ðŸ”– Update module version to $newVersion [skip ci]"
            git push origin ${{ github.ref_name }}
            
            Write-Output "âœ… Version updated and committed" >> $env:GITHUB_STEP_SUMMARY
          }

      - name: ðŸ”„ Re-fetch after version update
        if: steps.determine-version.outputs.should-release == 'true'
        run: |
          git fetch origin ${{ github.ref_name }}
          git reset --hard origin/${{ github.ref_name }}
          echo "âœ… Repository state synchronized"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸš€ GITHUB RELEASE - Draft, Smart Tags, Publish
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  github-release:
    name: ðŸš€ GitHub Release
    needs: [quality-gate, prepare-release]
    if: needs.prepare-release.outputs.should-release == 'true'
    runs-on: ${{ vars.UBUNTU_VERSION || 'ubuntu-24.04' }}
    outputs:
      release-created: ${{ steps.create-release.outputs.release-created }}
      release-tag: ${{ steps.create-release.outputs.release-tag }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Create GitHub Release (Draft)
        id: create-release
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $version = "${{ needs.prepare-release.outputs.new-version }}"
          $releaseTag = "v$version"
          $moduleName = "${{ needs.quality-gate.outputs.module-name }}"
          
          $releaseNotes = @"
          ## ðŸŽ‰ Release $releaseTag
          
          ### ðŸš€ Installation
          ``````powershell
          Install-Module -Name $moduleName -RequiredVersion $version
          ``````
          "@
          
          Set-Content -Path 'release_notes.md' -Value $releaseNotes
          
          gh release create $releaseTag `
            --title "ðŸš€ Release $releaseTag" `
            --notes-file release_notes.md `
            --generate-notes `
            --draft
          
          "release-created=true" >> $env:GITHUB_OUTPUT
          "release-tag=$releaseTag" >> $env:GITHUB_OUTPUT
          "âœ… **Draft release created:** ``$releaseTag``" >> $env:GITHUB_STEP_SUMMARY

      - name: ðŸ·ï¸ Create Smart Tags
        if: steps.create-release.outputs.release-created == 'true'
        shell: pwsh
        run: |
          git config user.name "${{ env.RELEASE_AUTHOR }}"
          git config user.email "${{ env.RELEASE_EMAIL }}"
          
          $tag = "${{ steps.create-release.outputs.release-tag }}"
          git tag -f latest $tag
          git push -f origin latest
          
          Write-Output "âœ… **Smart tags created:** ``latest``" >> $env:GITHUB_STEP_SUMMARY

      - name: âœ… Publish GitHub Release
        if: steps.create-release.outputs.release-created == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release edit "${{ steps.create-release.outputs.release-tag }}" --draft=false --latest
          echo "ðŸš€ **Release published:** \`${{ steps.create-release.outputs.release-tag }}\`" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ“¤ PUBLISH TO GITHUB PACKAGES
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  publish-package:
    name: ðŸ“¤ Publish to GitHub Packages
    needs: [bootstrap, quality-gate, prepare-release, github-release]
    if: needs.github-release.outputs.release-created == 'true'
    runs-on: ${{ vars.UBUNTU_VERSION || 'ubuntu-24.04' }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Re-Bootstrap Dependencies
        uses: actions/checkout@v4
        with:
          repository: GrexyLoco/K.PSGallery.PackageRepoProvider
          path: .bootstrap/K.PSGallery.PackageRepoProvider
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”§ Re-Initialize Environment
        shell: pwsh
        run: |
          ./.github/scripts/Initialize-Environment.ps1
          ./.github/scripts/Install-FromLocal.ps1

      - name: ðŸ“¤ Publish to GitHub Packages
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $secureToken = ConvertTo-SecureString -String $env:GITHUB_TOKEN -AsPlainText -Force
          $version = "${{ needs.prepare-release.outputs.new-version }}"
          
          Write-Output "## ðŸ“¤ Package Publication" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "**Version:** ``$version``" >> $env:GITHUB_STEP_SUMMARY
          
          try {
            ./.github/scripts/Publish-ToGitHubPackages.ps1 `
              -SecureToken $secureToken `
              -Version $version
            
            Write-Output "âœ… **Package published to GitHub Packages**" >> $env:GITHUB_STEP_SUMMARY
          } catch {
            Write-Output "âŒ **Publish failed:** $($_.Exception.Message)" >> $env:GITHUB_STEP_SUMMARY
            throw
          }
